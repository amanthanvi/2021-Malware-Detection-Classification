# -*- coding: utf-8 -*-
"""Data Download, Extraction, and Validation

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1qYZwCJovLyETv_AS74cTNUfogiG4c3Qb

Imports
"""

import opendatasets as od
import tarfile
import ember
import os
import lightgbm as lgb
import altair as alt

"""Data Download"""

od.download("https://ember.elastic.co/ember_dataset_2018_2.tar.bz2") #imports dataset

"""Data Extraction"""

tar = tarfile.open("./ember_dataset_2018_2.tar.bz2", "r:bz2")  
tar.extractall() #unzips and decompresses dataset
tar.close()

"""Data Validation"""

data_dir = "./ember2018" #instantiates data directory

ember.create_vectorized_features(data_dir, 1)
_ = ember.create_metadata(data_dir)

emberdf = ember.read_metadata(data_dir)
X_train, y_train, X_test, y_test = ember.read_vectorized_features(data_dir, feature_version=1)
lgbm_model = lgb.Booster(model_file=os.path.join(data_dir, "ember_model_2018.txt"))

plotdf = emberdf.copy()
gbdf = plotdf.groupby(["label", "subset"]).count().reset_index()
alt.Chart(gbdf).mark_bar().encode( #creates data validation graph
    alt.X('subset:O', axis=alt.Axis(title='Subset')),
    alt.Y('sum(sha256):Q', axis=alt.Axis(title='Number of samples')),
    alt.Color('label:N', scale=alt.Scale(range=["#00b300", "#3333ff", "#ff3333"]), legend=alt.Legend(values=["unlabeled", "benign", "malicious"]))
)
